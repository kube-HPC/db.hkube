import { DataSourcesCollection, StorageConfig } from './DataSource.d';
/*---------------------------------------------------------
 * Copyright (C) Hkube. All rights reserved.
 *--------------------------------------------------------*/
import Collection from './MongoDB/Collection';
import { Id } from './MongoDB/types';

export type FileMeta = {
    id: string;
    name: string;
    /** The file's location in the repository */
    path: string;
    /** Size in bytes */
    size: number;
    /** Mime type */
    type: string;
    /** An extra text content the user can upload per file */
    meta?: string;
    uploadedAt: number;
};

type DataSourceWithCredentials = {
    id?: Id;
    name: string;
    /** A commit message for the description */
    versionDescription: string;
    /** A hash generated by git for each version */
    commitHash: string;
    files: FileMeta[];
    isPartial: boolean;
    storage: StorageConfig;
    git: GitConfig;
    _credentials: Credentials;
};

export type Credentials = {
    storage?: {
        accessKeyId: string;
        secretAccessKey: string;
    };
    git?: {
        token: string;
        tokenName?: string;
    };
};

export type GitConfig = {
    kind: 'github' | 'gitlab' | 'internal';
    repositoryUrl: string;
};

export type StorageConfig = {
    kind: 'S3' | 'internal';
    endpoint: string;
    bucketName: string;
};

export type DataSource = Omit<DataSourceWithCredentials, '_credentials'>;

export type DataSourceMeta = {
    id: Id;
    name: string;
    versionDescription: string;
    filesCount: number;
    avgFileSize: string;
    totalSize: number;
    fileTypes: string[];
};

export type DataSourceWithMeta = DataSource & DataSourceMeta;

export type DataSourceVersion = {
    id: Id;
    versionDescription: string;
    commitHash: string;
};
export interface DataSourcesCollection
    extends Collection<DataSource>,
        DataSourceOverrides {
    create(props: {
        name: string;
        git: GitConfig;
        storage: StorageConfig;
        credentials: Credentials;
    }): Promise<DataSource>;
    createVersion(params: {
        name?: string;
        id?: Id;
        versionDescription: string;
    }): Promise<DataSourceWithCredentials>;
    updateFiles(params: {
        name?: string;
        id?: Id;
        commitHash: string;
        files: FileMeta[];
    }): Promise<DataSourceWithMeta>;
    fetchWithCredentials: (
        ...params: Parameters<typeof Collection.prototype.fetch>
    ) => Promise<DataSourceWithCredentials>;
    listDataSources(): Promise<DataSourceMeta[]>;
    listVersions(params: { name: string }): Promise<DataSourceVersion[]>;
    setRepositoryUrl({ name: string }, { url: string }): Promise<null>;
    updateCredentials(props: {
        name: string;
        credentials: Credentials;
        allowNotFound?: boolean;
    }): Promise<number>;
}
